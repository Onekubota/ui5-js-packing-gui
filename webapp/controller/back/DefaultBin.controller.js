/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["zscm/ewm/packoutbdlvs1/controller/BaseController","sap/m/MessageBox","zscm/ewm/packoutbdlvs1/service/ODataService","zscm/ewm/packoutbdlvs1/modelHelper/Global","zscm/ewm/packoutbdlvs1/utils/Util","zscm/ewm/packoutbdlvs1/modelHelper/Material","sap/ui/model/json/JSONModel","zscm/ewm/packoutbdlvs1/utils/Const","zscm/ewm/packoutbdlvs1/modelHelper/PackingMode","zscm/ewm/packoutbdlvs1/model/PackingMode","sap/ui/model/Filter","sap/ui/model/FilterOperator","zscm/ewm/packoutbdlvs1/utils/CustomError"],function(C,M,S,G,U,a,J,b,P,c,F,d,e){"use strict";var s="start-packing-button";var f="dummy-input";var g="audio-player";var w="pod---defaultbin--workcenter--input";var h="pod---defaultbin--storagebin--input";return C.extend("zscm.ewm.packoutbdlvs1.controller.DefaultBin",{sRouteName:"default",init:function(){this.setModel(c,"packingMode");this.setBusy(true);if(U.isEmpty(G.getWarehouseNumber())){this.displayWarehouseMissedMessage();}var r=S.getRuntimeEnvironment().then(function(R){if(U.isEmpty(G.getWarehouseNumber())){}else{this.bindAudioAggregation();}G.setIsOnCloud(R[0].IsS4Cloud);if(!R[0].IsS4Cloud&&P.getSelectedMode()!==b.INTERNAL_MODE){this.initPackingModeModel();}}.bind(this));var p=this.initPersonalizationService();this.setButtonToolTip("start-packing-button");return Promise.all([r,p]).then(function(){this.setBusy(false);}.bind(this)).catch(function(){this.setBusy(false);}.bind(this));},onRouteMatched:function(p){this.getOwnerComponent().getShellUIService().setBackNavigation();},bindWorkCenter:function(W){this.byId(w).bindElement({path:"/PackingStationSet(EWMWarehouse='"+G.getWarehouseNumber()+"',EWMWorkCenter='"+W+"',EWMStorageBin='')"});},bindStorageBin:function(W){this.byId(h).bindElement({path:"/PackingStationSet(EWMWarehouse='"+G.getWarehouseNumber()+"',EWMWorkCenter='"+W+"',EWMStorageBin='')"});},initPackingMode:function(){var p=this.getOwnerComponent().getComponentData().startupParameters.PackMode;if(U.isEmpty(p)){p=b.PACK_MODE.OUTBOUND;}else{p=parseInt(p[0],10);}S.setOdataHeader(p);if(p===b.PACK_MODE.OUTBOUND){var i=this.getDefaultPackingModeForOutbound();P.setSelectedMode(i);this.byId("mode-selection").setSelectedKey(i);}else{P.setSelectedMode(b.INTERNAL_MODE);}},displayWarehouseMissedMessage:function(){var m=this.getI18nText("specifyWorkCenter");var i=!!this.getView().$().closest(".sapUiSizeCompact").length;M.error(m,{styleClass:i?"sapUiSizeCompact":""});},initSubscription:function(){this.subscribe(b.EVENT_BUS.CHANNELS.USER_SETTING,b.EVENT_BUS.EVENTS.WAREHOUSE_CHANGED,function(){this.byId(s).setEnabled(false);this.updateInputWithDefault(w,"");this.updateInputWithDefault(h,"");this.bindAudioAggregation();if(U.isEmpty(G.getWarehouseNumber())){this.displayWarehouseMissedMessage();}}.bind(this));},initModel:function(){},isInTextAndIdFormat:function(v){if(v.length<6)return false;var l=v.substring(v.length-6,v.length-5);if(l!=="("){return false;}var i=v.substring(v.length-1,v.length);if(i!==")"){return false;}return true;},getIdFromTextAndIdFormat:function(v){return v.substring(v.length-5,v.length-1);},initWorkCenterModel:function(){var W=[];this.setBusy(true);this.oWorkCenterModel=new sap.ui.model.json.JSONModel();S.getWorkCenterSet().then(function(r){r.forEach(function(R){var o={WorkCenter:R.Workstation,Desc:R.Description};W.push(o);});this.oWorkCenterModel.setData(W);this.setBusy(false);}.bind(this)).catch(function(){this.setBusy(false);}.bind(this));},initStorageBinModel:function(){var o=[];this.setBusy(true);this.oStorageBinModel=new sap.ui.model.json.JSONModel();S.getStorageBinSet().then(function(r){r.forEach(function(R){var i={StorageBin:R.EWMStorageBin,StorageType:R.EWMStorageType};o.push(i);});this.oStorageBinModel.setData(o);this.setBusy(false);}.bind(this)).catch(function(){this.setBusy(false);}.bind(this));},initWorkCenterColModel:function(){this.oWorkCenterColModel=new sap.ui.model.json.JSONModel();var W=this.getI18nText("workCenter");var i=this.getI18nText("workCenterDesc");this.oWorkCenterColModel.setData({cols:[{label:W,template:b.WORKCENTER_KEY},{label:i,template:b.WORKCENTER_DESC}]});},initStorageBinColModel:function(){this.oStorageBinColModel=new sap.ui.model.json.JSONModel();var i=this.getI18nText("storageBin");var j=this.getI18nText("storageType");this.oStorageBinColModel.setData({cols:[{label:i,template:b.STORAGEBIN_KEY},{label:j,template:b.STORAGE_TYE}]});},initTableBinding:function(D){var t=D.getTable();if(t.bindRows){t.bindRows("/");}if(t.bindItems){t.bindAggregation("items","/",function(i,o){var j=t.getModel("columns").getData().cols;return new sap.m.ColumnListItem({cells:j.map(function(k){var l=k.template;return new sap.m.Label({text:"{"+l+"}"});})});});}},initPackingModeModel:function(){var A=this.getI18nText("advancedMode");var B=this.getI18nText("basicMode");var i=this.getI18nText("internalMode");var m=[{"key":b.ADVANCED_MODE,"text":A}];var o={"key":b.BASIC_MODE,"text":B};if(!G.isOnCloud()){m.push(o);}P.setModes(m);},getDefaultPackingModeForOutbound:function(){var D=this.oContainer.getItemValue("packingMode");if(U.isEmpty(D)){D=b.ADVANCED_MODE;}else if(D!==b.ADVANCED_MODE&&D!==b.BASIC_MODE){D=b.ADVANCED_MODE;}return D;},initPersonalizationService:function(){this.oPersonalizationService=this.getPersonalizationService();return new Promise(function(r,i){var j=this.getContainerId();this.oPersonalizationService.getContainer(j).fail(function(){this.oPersonalizationService.createEmptyContainer(j).done(function(o){this.oContainer=o;r();}.bind(this));}.bind(this)).done(function(o){this.oContainer=o;r();}.bind(this));}.bind(this)).then(function(){return this.initDisplayedValue();}.bind(this));},initDisplayedValue:function(){this.initPackingMode();var D="";D=this.oContainer.getItemValue("workCenter");this.byId(s).setEnabled(false);this.bindWorkCenter("");this.bindStorageBin("");if(!U.isEmpty(G.getWarehouseNumber())&&!U.isEmpty(D)){return this.verifyWorkCenter(D,true);}},onVerifyWorkCenter:function(v){var i=this.byId(w);if(v.length>4){this.handleEntryLengthExceed(i);return;}if(!U.isEmpty(v)){this.verifyWorkCenter(v).then(function(){this.setBusy(false);}.bind(this)).catch(function(){this.setBusy(false);}.bind(this));}else{G.setPackStation("");}},onWorkCenterChange:function(E){this.byId(s).setEnabled(false);this.focusDummyElement();var v=U.trim(E.getParameter("newValue")).toUpperCase();if(this.isInTextAndIdFormat(v)){v=this.getIdFromTextAndIdFormat(v);}this.onVerifyWorkCenter(v);},handleEntryLengthExceed:function(i){var E=this.getI18nText("workCenterMaximunCharacters");this.updateInputWithError(i,E);this.playAudio(b.ERROR);i.focus();},verifyWorkCenter:function(v,B){var i=this.byId(w);var D="";this.setBusy(true);return S.verifyWorkCenter(v).then(function(r){if(U.isEmpty(r.EWMWarehouse)||U.isEmpty(r.EWMWorkCenter)){throw new Error();}else{G.setWarehouseNumber(r.EWMWarehouse);G.setPackStation(r.EWMWorkCenter);G.setScaleEnabled(r.ScaleEnabled);G.setAsyncMode(!!r.IsUIAsync);if(B){this.bindWorkCenter(r.EWMWorkCenter.toUpperCase());}this.bindStorageBin(r.EWMWorkCenter.toUpperCase());D=r.EWMStorageBin;}}.bind(this)).then(function(){if(!U.isEmpty(D)){G.setBin(D);this.updateInputWithDefault(h,D);if(!U.isEmpty(this.byId("mode-selection").getSelectedKey())||P.getSelectedMode()===b.INTERNAL_MODE){this.byId(s).setEnabled(true);}}else{var o=this.byId(h);var j=o.getValue();if(!U.isEmpty(j)){o.fireChange({newValue:j});}else{this.updateInputWithDefault(o,"");}}this.focus(h);}.bind(this)).catch(function(E){this.setBusy(false);this.byId(s).setEnabled(false);if(U.isEmpty(E._vPara)){var j=this.getI18nText("incorrectWorkCenter",v);this.updateInputWithError(i,j);}else{this.updateInputWithError(i,E._vPara.MsgVar);}G.setPackStation("");this.playAudio(b.ERROR);i.focus();}.bind(this));},onWorkCenterSubmit:function(E){var v=U.trim(E.getParameter("value")).toUpperCase();this.onVerifyWorkCenter(v);},onStorageBinVerify:function(v){var W=this.byId(w);var i=G.getPackStation();var I=this.byId(h);if(U.isEmpty(i)){W.focus();this.updateInputWithDefault(I,v);return;}if(v.length>18){this.updateInputWithError(I);this.playAudio(b.ERROR);I.focus();return;}if(!U.isEmpty(v)){this.verifyStorageBin(v);}else{G.setBin("");}},onStorageBinChange:function(E){this.byId(s).setEnabled(false);this.focusDummyElement();var v=U.trim(E.getParameter("newValue")).toUpperCase();this.onStorageBinVerify(v);},verifyStorageBin:function(v){var i=this.byId(h);this.setBusy(true);return S.verifyStorageBin(v).then(function(r){this.setBusy(false);G.setBin(r.EWMStorageBin);this.updateInputWithDefault(i,v);if(!U.isEmpty(this.byId("mode-selection").getSelectedKey())||P.getSelectedMode()===b.INTERNAL_MODE){this.byId(s).setEnabled(true);}i.focus();}.bind(this)).catch(function(E){this.setBusy(false);if(U.isEmpty(E._vPara)){var j=this.getI18nText("incorrectStorageBin",v);this.updateInputWithError(i,j);}else{this.updateInputWithError(i,E._vPara.MsgVar);}this.playAudio(b.ERROR);i.focus();}.bind(this));},onStorageBinSubmit:function(E){var v=U.trim(E.getParameter("value")).toUpperCase();this.onStorageBinVerify(v);},onStartPacking:function(E){var W=G.getPackStation();var i=this.byId(h).getValue();var m=P.getSelectedMode();this.setBusy(true);S.getMaterialAndExceptionList().then(function(r){if(r[0].length===0){throw new e(b.ERRORS.NO_MATERIAL);}else{a.setData(r[0]);}G.setExceptionList(r[1]);}.bind(this)).then(function(){this.oContainer.setItemValue("workCenter",W);this.oContainer.setItemValue("storageBin",i);if(P.getSelectedMode()!==b.INTERNAL_MODE){this.oContainer.setItemValue("packingMode",m);}return this.oContainer.save();}.bind(this)).then(function(){var r=this.getRouter();if(m===b.ADVANCED_MODE){r.navTo(b.ADVANCED_ROUTE_NAME);}else if(m===b.BASIC_MODE){if(a.getFavoriteMaterials().length===0){throw new e(b.ERRORS.NO_FAVORITE_MATERIAL);}else{r.navTo(b.BASIC_ROUTE_NAME);}}else{r.navTo(b.INTERNAL_ROUTE_NAME);}}.bind(this)).then(function(){this.setBusy(false);}.bind(this)).catch(function(o){if(U.isEmpty(o._vPara)){if(o._sKey===b.ERRORS.NO_MATERIAL){var j=this.getI18nText("noMaterialInWarehouse",G.getWarehouseNumber());this.showErrorMessageBox(j);}else if(o._sKey===b.ERRORS.NO_FAVORITE_MATERIAL){var k=this.getI18nText("noFavoriteMaterialInWorkCenter",G.getPackStation());this.showErrorMessageBox(k);}}this.setBusy(false);}.bind(this));},onDefaultInputLiveChanged:function(){this.byId(s).setEnabled(false);},focusDummyElement:function(){this.byId(f).setValue("");this.byId(f).focus();},onPackingModeChange:function(E){var o=this.byId("mode-selection");var n=o.getSelectedKey();P.setSelectedMode(n);var W=G.getPackStation();var i=G.getBin();if(!U.isEmpty(W)&&!U.isEmpty(i)){this.byId(s).setEnabled(true);}},bindAudioAggregation:function(){var A=this.getAudioParent(this.oView);var W=new F("EWMWarehouse",d.EQ,G.getWarehouseNumber());A.getController().bindAudioList([W]);},getAudioParent:function(v){if(v.byId&&v.byId(g)){this.oAudio=v;}else{this.getAudioParent(v.getParent());}return this.oAudio;},createStorageBinFilter:function(t,i){var k=[b.STORAGEBIN_KEY,b.STORAGE_TYE];var j=this.getI18nText("storageBin");var l=this.getI18nText("storageType");var o=new sap.ui.comp.filterbar.FilterBar({advancedMode:true,filterBarExpanded:true,showGoOnFB:!sap.ui.Device.system.phone,filterGroupItems:[new sap.ui.comp.filterbar.FilterGroupItem({groupTitle:"foo",groupName:"gn1",name:"n1",label:j,control:new sap.m.Input()}),new sap.ui.comp.filterbar.FilterGroupItem({groupTitle:"foo",groupName:"gn1",name:"n2",label:l,control:new sap.m.Input()})],search:function(E){var m=E.getParameters().selectionSet[0].getProperty("value").toUpperCase();var n=E.getParameters().selectionSet[1].getProperty("value").toUpperCase();var p=[];p.push(m);p.push(n);i(t,k,p);}});return o;},createWorkCenterFilter:function(t,i){var k=[b.WORKCENTER_KEY,b.WORKCENTER_DESC];var W=this.getI18nText("workCenter");var j=this.getI18nText("workCenterDesc");var o=new sap.ui.comp.filterbar.FilterBar({advancedMode:true,filterBarExpanded:true,showGoOnFB:!sap.ui.Device.system.phone,filterGroupItems:[new sap.ui.comp.filterbar.FilterGroupItem({groupTitle:"foo",groupName:"gn1",name:"n1",label:W,control:new sap.m.Input()}),new sap.ui.comp.filterbar.FilterGroupItem({groupTitle:"foo",groupName:"gn1",name:"n2",label:j,control:new sap.m.Input()})],search:function(E){var l=E.getParameters().selectionSet[0].getProperty("value").toUpperCase();var m=E.getParameters().selectionSet[1].getProperty("value").toUpperCase();var n=[];n.push(l);n.push(m);i(t,k,n);}});return o;},filterTable:function(t,k,i){t.filter(U.getFilters(k,i));},handleWorkCenterValueHelp:function(E){this.initWorkCenterModel();this.creatValueHelpDialog("zscm.ewm.packoutbdlvs1.view.WorkCenterValueHelpDialog",this.oWorkCenterColModel,this.oWorkCenterModel,this.createWorkCenterFilter.bind(this));},handleStorageBinValueHelp:function(E){this.initStorageBinModel();this.creatValueHelpDialog("zscm.ewm.packoutbdlvs1.view.StorageBinValueHelpDialog",this.oStorageBinColModel,this.oStorageBinModel,this.createStorageBinFilter.bind(this));},creatValueHelpDialog:function(D,o,i,j){var k=sap.ui.xmlfragment(D,this);this.getView().addDependent(k);k.getTable().setModel(o,"columns");k.getTable().setModel(i);this.initTableBinding(k);var t=k.getTable().getBinding();var l=j(t,this.filterTable);k.setFilterBar(l);k.open();k.update();},_handleValueHelpClose:function(E){var D=E.getSource();D.close();},_handleWorkCenterValueHelpOK:function(E){var D=E.getSource();var t=E.getParameter("tokens").length;if(t>0){var T=E.getParameter("tokens")[t-1];var i=T.getKey();this.byId(w).setValue(i);this.byId(s).setEnabled(false);this.i(i);}D.close();},_handleStorageBinValueHelpOK:function(E){var D=E.getSource();var t=E.getParameter("tokens").length;if(t>0){var T=E.getParameter("tokens")[t-1];var i=T.getKey();this.byId(s).setEnabled(false);this.byId(h).setValue(i);this.onStorageBinVerify(i);}D.close();},_handleValueHelpCancle:function(E){var D=E.getSource();D.close();},_handleValueHelpAfterClose:function(E){var D=E.getSource();D.destroy();},formatUpperCase:function(v){if(!U.isEmpty(v)){return v.toUpperCase();}else{return"";}}});});
